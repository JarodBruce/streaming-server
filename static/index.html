<!DOCTYPE html>
<html>
<head>
    <title>Streaming Server</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f8f9fa; color: #343a40; }
        h1, h2 { color: #007bff; }
        #container { display: flex; gap: 2em; }
        #main-content { flex-grow: 1; }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            background-color: black;
        }
        video { width: 100%; display: block; }
        #video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        #video-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #playlist-container { min-width: 250px; }
        #playlist ul { list-style: none; padding: 0; margin: 0; }
        #playlist li { cursor: pointer; padding: 10px 15px; border-bottom: 1px solid #dee2e6; transition: background-color 0.2s; }
        #playlist li:hover, #playlist li.active { background-color: #e9ecef; }
        #status { margin-top: 1em; font-size: 1.2em; }
        #viewer-count { font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    <h1>Rust Streaming Server</h1>
    <div id="container">
        <div id="main-content">
            <div id="video-container">
                <video id="video-player" controls muted loop>
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div id="video-overlay"></div>
            </div>
            <div id="status">
                <p>Viewers: <span id="viewer-count">0</span></p>
            </div>
        </div>
        <div id="playlist-container">
            <h2>Playlist</h2>
            <div id="playlist">
                <ul id="video-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const videoPlayer = document.getElementById('video-player');
        const videoList = document.getElementById('video-list');
        const viewerCountSpan = document.getElementById('viewer-count');
        const videoOverlay = document.getElementById('video-overlay');
        
        const clientId = crypto.randomUUID();
        let videos = [];
        let userInteracted = false;
        let ws;

        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.count !== undefined) {
                        viewerCountSpan.textContent = data.count;
                    }
                } catch (e) {
                    console.error("Failed to parse WebSocket message:", e);
                }
            };

            ws.onclose = () => {
                console.log("WebSocket connection closed. Reconnecting in 3 seconds...");
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.error("WebSocket error:", err);
                ws.close();
            };
        }

        async function fetchVideos() {
            try {
                const response = await fetch('/videos');
                if (!response.ok) throw new Error('Failed to fetch video list');
                videos = await response.json();

                videoList.innerHTML = '';
                videos.forEach((video, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = video.name;
                    listItem.dataset.filename = video.name;
                    listItem.addEventListener('click', () => {
                        playVideo(video.name);
                        setActiveListItem(listItem);
                    });
                    videoList.appendChild(listItem);
                    if (index === 0) {
                        videoPlayer.src = `/video/${video.name}`;
                        setActiveListItem(listItem);
                    }
                });
            } catch (error) {
                console.error('Error fetching videos:', error);
                videoList.innerHTML = '<li>Could not load videos.</li>';
            }
        }

        function playVideo(filename) {
            if (!userInteracted) return;
            
            videoPlayer.src = `/video/${filename}`;
            const promise = videoPlayer.play();
            if (promise !== undefined) {
                promise.catch(error => console.error("Playback error:", error));
            }
        }

        function setActiveListItem(selectedItem) {
            videoList.querySelectorAll('li').forEach(item => item.classList.remove('active'));
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
        }

        async function sendHeartbeat() {
            // Only send heartbeats if the document has focus to be more efficient
            if (document.hasFocus()) {
                try {
                    await fetch('/heartbeat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ client_id: clientId }),
                    });
                } catch (error) {
                    console.error('Error sending heartbeat:', error);
                }
            }
        }

        videoOverlay.addEventListener('click', () => {
            userInteracted = true;
            videoOverlay.classList.add('hidden');
            const firstVideo = videos[0];
            if (firstVideo) {
                playVideo(firstVideo.name);
            }
        }, { once: true });

        // --- Initial Setup ---
        fetchVideos();
        connectWebSocket();
        
        // Heartbeat is still useful to know which clients are active
        setInterval(sendHeartbeat, 100);

    </script>
</body>
</html>
